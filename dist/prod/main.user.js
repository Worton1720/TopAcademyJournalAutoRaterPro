// ==UserScript==
// @name      Top Academy Journal Auto Rater Pro
// @version      0.4
// @description      –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ journal
// @author      Rodion
// @match      https://journal.top-academy.ru/*
// @grant      GM_getValue
// @grant      GM_setValue
// @grant      GM_registerMenuCommand
// @grant      GM_addStyle
// @run-at      document-end
// ==/UserScript==

!function(){"use strict";const t={ZOOM_LEVEL:"80%",PROGRESS_PAGE_REGEX:"https://journal.top-academy.ru/.*/main/progress/.*"};class e{constructor(t,e){this.config={...t},this.onSaveCallback=e,this.modal=null,this.overlay=null,this.fields=[{key:"ZOOM_LEVEL",label:"–£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 80%)",type:"text",placeholder:"80%",validate:t=>""!==t.trim()||"–ü–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º"}]}show(){document.getElementById("ta-config-modal")?document.getElementById("ta-config-modal").querySelector("input,textarea,button").focus():this.createModal()}createModal(){this.overlay=document.createElement("div"),this.overlay.id="ta-config-modal",Object.assign(this.overlay.style,{position:"fixed",inset:"0",background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:99999}),this.modal=document.createElement("div"),Object.assign(this.modal.style,{width:"520px",maxWidth:"95%",background:"#fff",borderRadius:"8px",padding:"16px",boxShadow:"0 10px 30px rgba(0,0,0,0.25)",fontFamily:"Arial, sans-serif",color:"#111"}),this.modal.innerHTML='\n\t\t\t<h2 style="margin:0 0 8px 0; font-size:18px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞</h2>\n\t\t\t<div style="margin-bottom:10px; color:#555; font-size:13px;">\n\t\t\t\t–ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.\n\t\t\t</div>\n\t\t';const t=document.createElement("div");t.style.marginTop="8px",this.modal.appendChild(t),this.fields.forEach(e=>{const n=document.createElement("label");n.style.display="block",n.style.marginTop="8px",n.style.fontWeight="600",n.style.fontSize="13px",n.textContent=e.label;const s=document.createElement("input");s.type=e.type||"text",s.placeholder=e.placeholder||"",s.value=this.config[e.key]||"",s.dataset.key=e.key,Object.assign(s.style,{width:"100%",padding:"8px",marginTop:"6px",boxSizing:"border-box"}),n.appendChild(s),t.appendChild(n)});const e=document.createElement("div");Object.assign(e.style,{marginTop:"12px",display:"flex",gap:"8px",justifyContent:"flex-end"}),e.innerHTML='\n\t\t\t<button id="ta-cfg-defaults" style="padding:6px 10px; cursor:pointer;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>\n\t\t\t<button id="ta-cfg-cancel" style="padding:6px 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>\n\t\t\t<button id="ta-cfg-save" style="padding:6px 12px; background:#2b6cb0; color:#fff; border:none; border-radius:4px; cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\n\t\t',this.modal.appendChild(e);const n=document.createElement("div");n.id="ta-cfg-error",n.style.cssText="margin-top:10px; color:#b00020; display:none; font-size:13px;",this.modal.appendChild(n),this.overlay.appendChild(this.modal),document.body.appendChild(this.overlay),this.setupEvents(n)}setupEvents(t){this.modal.querySelector('input[data-key="ZOOM_LEVEL"]');const e=this.modal.querySelector("#ta-cfg-save"),n=this.modal.querySelector("#ta-cfg-cancel"),s=this.modal.querySelector("#ta-cfg-defaults"),i=e=>{e?(t.style.display="block",t.textContent=e):(t.style.display="none",t.textContent="")},a=()=>{this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)};s.addEventListener("click",()=>{this.fields.forEach(t=>{this.modal.querySelector(`input[data-key="${t.key}"]`).value=t.placeholder||""}),i(null)}),n.addEventListener("click",a),e.addEventListener("click",async()=>{i(null);const t={};for(const e of this.fields){const n=this.modal.querySelector(`input[data-key="${e.key}"]`).value.trim();if(e.validate){const t=e.validate(n);if(!0!==t)return void i(t)}t[e.key]=n}try{"function"==typeof this.onSaveCallback&&await this.onSaveCallback(t),a()}catch(t){i("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: "+(t.message||t))}}),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&a()});window.addEventListener("keydown",t=>{"Escape"===t.key&&a()})}}function n(){let t=document.getElementById("attendance-stats");if(t)return t;const e=document.createElement("div");return e.id="attendance-stats",e.innerHTML='\n<header>\n  <span>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>\n  <button id="toggle-stats" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ØÜ</button>\n</header>\n<div class="stats-body" style="margin-top:8px;">\n  <label>–°: <input type="date" id="date-from"></label>\n  <label>–ü–æ: <input type="date" id="date-to"></label>\n  <div style="margin-top:8px; display:flex; gap:6px;">\n    <button id="reset-stats">–°–±—Ä–æ—Å–∏—Ç—å</button>\n    <button id="refresh-stats" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>\n  </div>\n  <div id="stats-content" style="margin-top:10px; line-height:1.4;">\n    –í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π: 0<br>\n    <span class="present">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è: 0</span><br>\n    <span class="lateness">–û–ø–æ–∑–¥–∞–Ω–∏—è: 0</span><br>\n    <span class="absent">–ü—Ä–æ–ø—É—Å–∫–∏: 0</span><br>\n    –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: <b>0%</b>\n    <div class="progress-bar"><div class="progress-bar-inner"></div></div>\n  </div>\n</div>\n',document.body.appendChild(e),e}function s(){const t=document.getElementById("attendance-stats");t&&t.parentNode&&t.parentNode.removeChild(t)}GM_addStyle('\n  /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */\n  #attendance-stats {\n    position: fixed;\n    top: 10%;\n    right: 10px;\n    background: #fff;\n    border-radius: 12px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;\n    font-size: 14px;\n    width: 240px;\n    padding: 12px;\n    z-index: 9999;\n    transition: all 0.3s ease;\n  }\n\n  /* —Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */\n  #attendance-stats.collapsed {\n    width: 40px;\n    height: 40px;\n    overflow: hidden;\n    padding: 6px;\n  }\n\n  /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ */\n  #attendance-stats header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    font-weight: 600;\n    font-size: 15px;\n  }\n\n  /* –∫–Ω–æ–ø–∫–∞ */\n  #attendance-stats button {\n    border: none;\n    background: #e5e7eb;\n    border-radius: 6px;\n    padding: 4px 8px;\n    margin-top: 6px;\n    cursor: pointer;\n    transition: background 0.2s;\n    font-size: 13px;\n  }\n  #attendance-stats button:hover {\n    background: #d1d5db;\n  }\n\n  /* –∫–Ω–æ–ø–∫–∞ "–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å" */\n  #attendance-stats #toggle-stats {\n    background: none;\n    font-size: 16px;\n    padding: 0;\n    margin: 0;\n  }\n\n  /* –º–µ—Ç–∫–∏ */\n  #attendance-stats label {\n    display: block;\n    margin-top: 6px;\n    font-size: 13px;\n  }\n\n  /* –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–∞—Ç—ã */\n  #attendance-stats input[type="date"] {\n    width: 100%;\n    padding: 6px;\n    border: 1px solid #ccc;\n    border-radius: 6px;\n    margin-top: 4px;\n    font-size: 13px;\n  }\n\n  /* —Ü–≤–µ—Ç–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è */\n  #attendance-stats .present { color: #16a34a; }\n  #attendance-stats .lateness { color: #d97706; }\n  #attendance-stats .absent { color: #dc2626; }\n\n  /* –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */\n  #attendance-stats .progress-bar {\n    margin-top: 6px;\n    height: 8px;\n    border-radius: 4px;\n    background: #e5e7eb;\n    overflow: hidden;\n  }\n  #attendance-stats .progress-bar-inner {\n    height: 100%;\n    background: #16a34a;\n    width: 0%;\n    transition: width 0.4s ease;\n  }\n\t/* —Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */\n\t#attendance-stats.collapsed .stats-body {\n\t\tdisplay: none;\n\t}\n\t#attendance-stats.collapsed header span {\n\t\tdisplay: none; /* —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ */\n\t}\n');class i{constructor(t){this.CONFIG=t,this.widget=null,this.isCollapsed=!1,this.rangeStart=null,this.rangeEnd=null,this.updateAttendanceStats=function(t,e){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>t.apply(this,s),e)}}(this.updateAttendanceStats.bind(this),300),this.init()}init(){this.setPageZoom(),this.isProgressPage()&&this.initAttendanceStats(),this.setupNavigationObserver()}isProgressPage(){return this.CONFIG.PROGRESS_PAGE_REGEX.test(window.location.href)}setPageZoom(){document.documentElement.style.zoom=this.CONFIG.ZOOM_LEVEL}initAttendanceStats(){this.widget||(this.widget=n(),this.setDefaultDateRange(),this.setupWidgetControls(),this.setupRangeSelection(),this.setupDateInputListeners()),this.updateAttendanceStats()}setDefaultDateRange(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");this.rangeStart=new Date(e,t.getMonth(),1),this.rangeStart.setHours(0,0,0,0),this.rangeEnd=new Date(e,t.getMonth(),t.getDate()),this.rangeEnd.setHours(23,59,59,999),this.widget.querySelector("#date-from").value=`${e}-${n}-01`,this.widget.querySelector("#date-to").value=`${e}-${n}-${s}`}setupWidgetControls(){const t=this.widget.querySelector("#reset-stats"),e=this.widget.querySelector("#refresh-stats"),n=this.widget.querySelector("#toggle-stats");this.widget.querySelector("strong"),this.widget.querySelector(".stats-body"),t.addEventListener("click",()=>{this.setDefaultDateRange(),this.clearHighlights(),this.updateAttendanceStats()}),e.addEventListener("click",()=>{this.updateAttendanceStats(),this.highlightRange()}),n.addEventListener("click",()=>{this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.widget.classList.add("collapsed"),n.textContent="‚Øà"):(this.widget.classList.remove("collapsed"),n.textContent="‚ØÜ")})}setupDateInputListeners(){const t=this.widget.querySelector("#date-from"),e=this.widget.querySelector("#date-to");t.addEventListener("change",t=>{if(t.target.value){const e=new Date(t.target.value);e.setHours(0,0,0,0),this.rangeStart=e,this.updateAttendanceStats()}}),e.addEventListener("change",t=>{if(t.target.value){const e=new Date(t.target.value);e.setHours(23,59,59,999),this.rangeEnd=e,this.updateAttendanceStats()}})}updateAttendanceStats(){if(!this.isProgressPage())return void s();this.widget||(this.widget=n()),this.syncDateInputs();const t=this.rangeStart,e=this.rangeEnd?new Date(this.rangeEnd):null;e&&e.setHours(23,59,59,999);const i=Array.from(document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass")).filter(n=>{const s=n.querySelector(".date")?.textContent.trim();if(!s)return!1;const[i,a,o]=s.split(".").map(Number),r=new Date(o,a-1,i);r.setHours(12,0,0,0);return(!t||r>=t)&&(!e||r<=e)}),a=i.length,o=i.filter(t=>t.classList.contains("lateness")).length,r=i.filter(t=>t.classList.contains("pass")).length,l=Math.max(0,i.filter(t=>!t.classList.contains("pass")).length-o),d=a>0?(l/a*100).toFixed(1):0;this.widget.querySelector("#stats-content").innerHTML=`\n\t\t–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π: ${a}<br>\n\t\t<span class="present">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è: ${l}</span><br>\n\t\t<span class="lateness">–û–ø–æ–∑–¥–∞–Ω–∏—è: ${o}</span><br>\n\t\t<span class="absent">–ü—Ä–æ–ø—É—Å–∫–∏: ${r}</span><br>\n\t\t–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: <b>${d}%</b>\n\t\t<div class="progress-bar"><div class="progress-bar-inner" style="width:${d}%;"></div></div>\n\t`,console.log("Selected date range:",t,e),this.highlightRange()}syncDateInputs(){const t=this.widget.querySelector("#date-from"),e=this.widget.querySelector("#date-to");if(this.rangeStart){const e=new Date(this.rangeStart);t.value=e.toISOString().split("T")[0]}if(this.rangeEnd){const t=new Date(this.rangeEnd);e.value=t.toISOString().split("T")[0]}}setupRangeSelection(){document.body.addEventListener("click",t=>{const e=t.target.closest(".lessons, .lessons.lateness, .lessons.pass");if(!e)return;const n=e.querySelector(".date");if(!n)return;const[s,i,a]=n.textContent.trim().split(".").map(Number),o=new Date(a,i-1,s);o.setHours(12,0,0,0),t.shiftKey?this.rangeStart?this.rangeEnd=o:this.rangeStart=o:(this.rangeStart=o,this.rangeEnd=o),this.rangeStart&&this.rangeEnd&&this.rangeStart>this.rangeEnd&&([this.rangeStart,this.rangeEnd]=[this.rangeEnd,this.rangeStart]),this.syncDateInputs(),this.updateAttendanceStats()})}highlightRange(){if(this.clearHighlights(),!this.rangeStart||!this.rangeEnd)return;Array.from(document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass")).map(t=>{const e=t.querySelector(".date");if(!e)return null;const[n,s,i]=e.textContent.trim().split(".").map(Number),a=new Date(i,s-1,n);return a.setHours(12,0,0,0),{lesson:t,dt:a}}).filter(t=>t&&t.dt>=this.rangeStart&&t.dt<=this.rangeEnd).forEach(({lesson:t})=>{t.style.boxShadow="",t.style.border="",t.style.position=t.style.position||"relative",t.style.boxSizing="border-box",t.style.border="2px solid green"})}clearHighlights(){document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass").forEach(t=>{t.style.border=""})}setupNavigationObserver(){let t=window.location.href;new MutationObserver(()=>{const e=window.location.href;e!==t&&(t=e,this.isProgressPage()?this.initAttendanceStats():s())}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("popstate",()=>{this.isProgressPage()?this.initAttendanceStats():s()})}cleanup(){s()}}class a{constructor(){this.ratingSelector=".bs-rating-star",this.activeClass="active",this.maxRating=5,this.observer=null,this.retryAttempts=3,this.retryDelay=1e3,this.pendingRetries=new Map,this.homeworkModalSelector="hw-upload-homework",this.isProcessing=!1,this.processedModals=new Set,this.init()}init(){this.setupMutationObserver()}isHomeworkModalOpen(){return null!==document.querySelector(this.homeworkModalSelector)}setupMutationObserver(){this.observer=new MutationObserver(t=>{t.forEach(t=>{if(t.addedNodes.length>0&&!this.isProcessing){const t=document.querySelector(this.homeworkModalSelector);t&&!this.processedModals.has(t)&&(console.log("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –î–ó"),this.isProcessing=!0,this.processedModals.add(t),setTimeout(()=>{this.processHomework(),this.isProcessing=!1},1e3))}})}),this.observer.observe(document.body,{childList:!0,subtree:!0})}processHomework(){console.log("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –î–ó"),this.fillTimeSpent(),this.rateMaximum(),this.selectPositiveTags()}fillTimeSpent(){const t=document.querySelectorAll(".text-homework-time-spent-wrap input");t.length>=2&&(t[0].value=Math.floor(2*Math.random())+1,t[1].value=Math.floor(31*Math.random())+15,console.log("‚è∞ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó"))}rateMaximum(){document.querySelectorAll(".emoji-evaluation").forEach(t=>{const e=this.generateContainerId(t);if(this.pendingRetries.has(e))return;const n=t.querySelectorAll(this.ratingSelector);if(n.length===this.maxRating){const s=n[this.maxRating-1];if(s.classList.contains(this.activeClass))console.log("‚úÖ –û—Ü–µ–Ω–∫–∞ –î–ó —É–∂–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –º–∞–∫—Å–∏–º—É–º");else{console.log("‚≠ê –ö–ª–∏–∫–∞–µ–º –Ω–∞ 5-—é –∑–≤–µ–∑–¥—É –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –î–ó");this.clickStar(s)&&this.startRetryCycle(t,e,0)}}})}selectPositiveTags(){console.log("üîç –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏...");const t=document.querySelectorAll(".evaluation-tags-item");t.forEach((t,e)=>{const n=t.querySelector("span")?.textContent,s=this.isElementVisible(t),i=t.classList.contains("selected");console.log(`–¢–µ–≥ ${e+1}: "${n}", –≤–∏–¥–∏–º: ${s}, –≤—ã–±—Ä–∞–Ω: ${i}`)});const e=["–í—Å–µ –∫—Ä—É—Ç–æ!","–í—Å–µ –ø–æ–Ω—è—Ç–Ω–æ!","–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è"];let n=0;t.forEach(t=>{if(!this.isElementVisible(t))return;const s=t.querySelector("span")?.textContent;if(console.log(`–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–≥: "${s}"`),s&&e.includes(s)&&!t.classList.contains("selected")&&n<2)try{return t.click(),console.log(`‚úÖ –í—ã–±—Ä–∞–Ω —Ç–µ–≥: "${s}"`),void n++}catch(t){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–µ–≥–∞:",t)}}),0===n&&console.log("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–µ–≥–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞")}generateContainerId(t){return Array.from(t.parentNode.children).indexOf(t)}startRetryCycle(t,e,n){if(n>=this.retryAttempts)return console.log("‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –î–ó"),void this.pendingRetries.delete(e);console.log(`‚è≥ –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ü–µ–Ω–∫–∏ –î–ó (–ø–æ–ø—ã—Ç–∫–∞ ${n+1}/${this.retryAttempts})...`),this.pendingRetries.set(e,setTimeout(()=>{this.checkRatingSuccess(t,e,n)},this.retryDelay))}checkRatingSuccess(t,e,n){const s=t.querySelectorAll(this.ratingSelector);if(0===s.length)return console.log("‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ü–µ–Ω–∫–∏ –∏—Å—á–µ–∑–ª–∏"),void this.pendingRetries.delete(e);const i=s[this.maxRating-1];if(i.classList.contains(this.activeClass))console.log("‚úÖ –û—Ü–µ–Ω–∫–∞ –î–ó —É—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞!"),this.pendingRetries.delete(e);else{console.log("‚ùå –û—Ü–µ–Ω–∫–∞ –î–ó –Ω–µ –ø—Ä–æ—à–ª–∞, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...");this.clickStar(i)?this.startRetryCycle(t,e,n+1):(console.log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –∑–≤–µ–∑–¥—É"),this.pendingRetries.delete(e))}}clickStar(t){if(this.isElementVisible(t)&&this.isElementClickable(t))try{const e=t.querySelector("button.rating-star");return e?(e.click(),!0):(t.click(),!0)}catch(t){return console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–≤–µ–∑–¥—É:",t),!1}return!1}isElementVisible(t){return t&&t.offsetWidth>0&&t.offsetHeight>0&&"hidden"!==window.getComputedStyle(t).visibility&&"none"!==window.getComputedStyle(t).display}isElementClickable(t){const e=window.getComputedStyle(t);return"none"!==e.pointerEvents&&"pointer"===e.cursor&&!t.hasAttribute("disabled")}cleanup(){this.observer&&this.observer.disconnect(),this.pendingRetries.forEach((t,e)=>{clearTimeout(t),this.pendingRetries.delete(e)})}}(async()=>{const n=await async function(){const e=await GM_getValue("config",t);let n=t.PROGRESS_PAGE_REGEX;"string"==typeof e.PROGRESS_PAGE_REGEX?n=e.PROGRESS_PAGE_REGEX:e.PROGRESS_PAGE_REGEX&&"string"==typeof e.PROGRESS_PAGE_REGEX.source&&(n=e.PROGRESS_PAGE_REGEX.source);try{e.PROGRESS_PAGE_REGEX=new RegExp(n)}catch{console.warn("–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π Regex, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç"),e.PROGRESS_PAGE_REGEX=new RegExp(t.PROGRESS_PAGE_REGEX)}return e}(),s=new i(n),o=new a;GM_registerMenuCommand("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞",()=>{new e(n,async t=>{await async function(t){const e={...t};e.PROGRESS_PAGE_REGEX instanceof RegExp&&(e.PROGRESS_PAGE_REGEX=e.PROGRESS_PAGE_REGEX.source),await GM_setValue("config",e)}(t),s.updateAttendanceStats()}).show()}),window.addEventListener("unload",()=>{s.cleanup(),o.cleanup()})})()}();
