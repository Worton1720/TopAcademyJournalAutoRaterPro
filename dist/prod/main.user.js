// ==UserScript==
// @name      Top Academy Journal Auto Rater Pro
// @version      0.6
// @description      Автоматизация процессов journal
// @author      Rodion
// @match      https://journal.top-academy.ru/*
// @grant      GM_getValue
// @grant      GM_setValue
// @grant      GM_registerMenuCommand
// @grant      GM_addStyle
// @run-at      document-end
// ==/UserScript==

!function(){"use strict";const e={ZOOM_LEVEL:"80%",PROGRESS_PAGE_REGEX:"https://journal.top-academy.ru/.*/main/progress/.*",AUTO_RATE_ENABLED:!0,AUTO_SUBMIT_ENABLED:!0};class t{constructor(){this.config={...e},this.listeners=new Set}async loadConfig(){try{const t=await GM_getValue("config",{});let n=t.ZOOM_LEVEL||e.ZOOM_LEVEL;"number"==typeof n?n=`${n}%`:"string"!=typeof n||n.includes("%")||(n=`${n}%`),this.config={...e,...t,ZOOM_LEVEL:n},this.notifyListeners()}catch(t){console.warn("Ошибка загрузки конфигурации, используются значения по умолчанию.\nWarning: "+t),this.config={...e},this.notifyListeners()}}async saveConfig(e){try{let t=e.ZOOM_LEVEL||this.config.ZOOM_LEVEL;"number"==typeof t?t=`${t}%`:"string"!=typeof t||t.includes("%")||(t=`${t}%`),this.config={...this.config,...e,ZOOM_LEVEL:t};const n={...this.config};return n.PROGRESS_PAGE_REGEX instanceof RegExp&&(n.PROGRESS_PAGE_REGEX=n.PROGRESS_PAGE_REGEX.toString()),await GM_setValue("config",n),this.notifyListeners(),!0}catch(e){return console.error("Ошибка сохранения конфигурации:",e),!1}}addChangeListener(e){return this.listeners.add(e),()=>this.listeners.delete(e)}removeChangeListener(e){this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.config)}catch(e){console.error("Ошибка в слушателе конфигурации:",e)}})}registerMenuCommands(e){try{GM_registerMenuCommand("Настройки скрипта",()=>{e.emit("config:show-ui")}),console.log('Меню-команда "Настройки скрипта" зарегистрирована')}catch(e){console.error("Ошибка регистрации меню-команды:",e)}}}class n{constructor(){this.events=new Map}on(e,t){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t),()=>this.off(e,t)}off(e,t){this.events.has(e)&&this.events.get(e).delete(t)}emit(e,t){this.events.has(e)&&this.events.get(e).forEach(n=>{try{n(t)}catch(t){console.error(`Ошибка в обработчике события ${e}:`,t)}})}cleanup(){this.events.clear()}}function s(){i();const e=document.createElement("div");return e.id="attendance-stats-widget",e.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: white;\n        border: 2px solid #007bff;\n        border-radius: 8px;\n        padding: 15px;\n        z-index: 9999;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        min-width: 280px;\n        font-family: Arial, sans-serif;\n        transition: all 0.3s ease;\n    ",e.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">\n            <h3 style="margin: 0; font-size: 16px; color: #007bff;">Статистика посещаемости</h3>\n            <button id="toggle-stats" style="background: none; border: none; font-size: 16px; cursor: pointer;">⯆</button>\n        </div>\n        \n        <div id="stats-content" style="margin-bottom: 15px;">\n            Загрузка статистики...\n        </div>\n        \n        <div style="margin-bottom: 10px;">\n            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Период:</label>\n            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">\n                <input type="date" id="date-from" style="flex: 1; padding: 5px; box-sizing: border-box;">\n                <span style="font-weight: bold;">—</span>\n                <input type="date" id="date-to" style="flex: 1; padding: 5px; box-sizing: border-box;">\n            </div>\n        </div>\n        \n        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n            <button id="reset-stats" style="padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Сброс</button>\n            <button id="refresh-stats" style="padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Обновить</button>\n        </div>\n        \n        <style>\n            .progress-bar {\n                width: 100%;\n                height: 8px;\n                background: #e9ecef;\n                border-radius: 4px;\n                margin-top: 5px;\n                overflow: hidden;\n            }\n            \n            .progress-bar-inner {\n                height: 100%;\n                background: #28a745;\n                transition: width 0.3s ease;\n            }\n            \n            .present { color: #28a745; }\n            .lateness { color: #ffc107; }\n            .absent { color: #dc3545; }\n            \n            #attendance-stats-widget.collapsed {\n                height: 40px;\n                overflow: hidden;\n                min-width: auto;\n                width: 200px;\n            }\n            \n            #attendance-stats-widget.collapsed > *:not(:first-child) {\n                display: none;\n            }\n        </style>\n    ',document.body.appendChild(e),e}function i(){const e=document.getElementById("attendance-stats-widget");e&&e.remove()}function o(e){if(!e)return!1;const t=window.getComputedStyle(e);return e.offsetWidth>0&&e.offsetHeight>0&&"hidden"!==t.visibility&&"none"!==t.display&&"0"!==t.opacity}class a{constructor({eventBus:e,config:t}){this.eventBus=e,this.config=t,this.widget=null,this.isCollapsed=!1,this.rangeStart=null,this.rangeEnd=null,this.updateAttendanceStats=function(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}}(this.updateAttendanceStats.bind(this),300),this.navigationObserver=null,this.lastUrl=window.location.href,this.navigationCheckTimeout=null}init(){this.setupEventListeners(),this.applyConfigImmediately(),this.isProgressPage()&&this.initAttendanceStats(),this.setupNavigationObserver()}setupEventListeners(){this.eventBus.on("config:updated",()=>this.onConfigUpdated()),this.eventBus.on("page:changed",()=>this.onPageChanged())}onConfigUpdated(){this.applyConfigImmediately(),this.isProgressPage()?this.updateAttendanceStats():i()}applyConfigImmediately(){this.setPageZoom()}setPageZoom(){let e=this.config.ZOOM_LEVEL;"number"==typeof e?e=`${e}%`:"string"!=typeof e||e.includes("%")||(e=`${e}%`),document.documentElement.style.zoom=e}isProgressPage(){if("string"==typeof this.config.PROGRESS_PAGE_REGEX)try{return new RegExp(this.config.PROGRESS_PAGE_REGEX).test(window.location.href)}catch(e){return console.error("Invalid regex pattern:",e),!1}return this.config.PROGRESS_PAGE_REGEX instanceof RegExp?this.config.PROGRESS_PAGE_REGEX.test(window.location.href):/https:\/\/journal\.top-academy\.ru\/.*\/main\/progress\/.*/.test(window.location.href)}initAttendanceStats(){this.widget||(this.widget=s(),this.setDefaultDateRange(),this.setupWidgetControls(),this.setupRangeSelection(),this.setupDateInputListeners()),this.updateAttendanceStats()}setDefaultDateRange(){const e=new Date,t=e.getFullYear();this.rangeStart=new Date(t,e.getMonth(),1),this.rangeStart.setHours(0,0,0,0),this.rangeEnd=new Date(t,e.getMonth(),e.getDate()),this.rangeEnd.setHours(23,59,59,999),this.syncDateInputs()}setupWidgetControls(){if(!this.widget)return;const e=this.widget.querySelector("#reset-stats"),t=this.widget.querySelector("#refresh-stats"),n=this.widget.querySelector("#toggle-stats");e.addEventListener("click",()=>{this.setDefaultDateRange(),this.clearHighlights(),this.updateAttendanceStats()}),t.addEventListener("click",()=>{this.updateAttendanceStats(),this.highlightRange()}),n.addEventListener("click",()=>{this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.widget.classList.add("collapsed"),n.textContent="⯈"):(this.widget.classList.remove("collapsed"),n.textContent="⯆")})}setupDateInputListeners(){if(!this.widget)return;const e=this.widget.querySelector("#date-from"),t=this.widget.querySelector("#date-to"),n=()=>{const n=e.value,s=t.value;if(n){const e=new Date(n);e.setHours(0,0,0,0),this.rangeStart=e}else this.rangeStart=null;if(s){const e=new Date(s);e.setHours(23,59,59,999),this.rangeEnd=e}else this.rangeEnd=null;this.updateAttendanceStats()};e.addEventListener("change",n),t.addEventListener("change",n)}updateAttendanceStats(){this.isProgressPage()?requestAnimationFrame(()=>{this.widget||(this.widget=s());const e=this.calculateStats();this.widget&&(this.widget.querySelector("#stats-content").innerHTML=`\n                Всего занятий: ${e.total}<br>\n                <span class="present">Присутствия: ${e.present}</span><br>\n                <span class="lateness">Опоздания: ${e.lateness}</span><br>\n                <span class="absent">Пропуски: ${e.absent}</span><br>\n                Посещаемость: <b>${e.percentage}%</b>\n                <div class="progress-bar"><div class="progress-bar-inner" style="width:${e.percentage}%;"></div></div>\n            `),requestAnimationFrame(()=>this.highlightRange())}):i()}calculateStats(){const e=this.rangeStart,t=this.rangeEnd,n=document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass");let s=0,i=0,o=0;for(let a=0;a<n.length;a++){const r=n[a],l=r.querySelector(".date")?.textContent.trim();if(!l)continue;const[c,d,h]=l.split(".").map(Number),u=new Date(h,d-1,c);u.setHours(12,0,0,0);(!e||u>=e)&&(!t||u<=t)&&(s++,r.classList.contains("lateness")&&i++,r.classList.contains("pass")&&o++)}const a=s-(o+i);return{total:s,present:a,lateness:i,absent:o,percentage:s>0?((a+i)/s*100).toFixed(1):0}}syncDateInputs(){if(!this.widget)return;const e=this.widget.querySelector("#date-from"),t=this.widget.querySelector("#date-to");if(this.rangeStart){const t=new Date(this.rangeStart);e.value=t.toISOString().split("T")[0]}else e.value="";if(this.rangeEnd){const e=new Date(this.rangeEnd);t.value=e.toISOString().split("T")[0]}else t.value=""}setupRangeSelection(){document.body.addEventListener("click",e=>{const t=e.target.closest(".lessons, .lessons.lateness, .lessons.pass");if(!t)return;const n=t.querySelector(".date");if(!n)return;const[s,i,o]=n.textContent.trim().split(".").map(Number),a=new Date(o,i-1,s);a.setHours(12,0,0,0),e.shiftKey?this.rangeEnd=a:(this.rangeStart=a,this.rangeEnd=null),this.updateAttendanceStats()})}highlightRange(){this.clearHighlights(),this.rangeStart&&this.rangeEnd&&requestAnimationFrame(async()=>{const e=document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass");for(let t=0;t<e.length;t++){const n=e[t],s=n.querySelector(".date");if(!s)continue;const i=s.textContent.trim();if(!i)continue;const[o,a,r]=i.split(".").map(Number),l=new Date(r,a-1,o);l.setHours(12,0,0,0);this.rangeStart&&l>=this.rangeStart&&this.rangeEnd&&l<=this.rangeEnd&&(this.rangeStart&&l.getTime()===this.rangeStart.getTime()||this.rangeEnd&&l.getTime()===this.rangeEnd.getTime()?n.style.border="2px solid #ff6b00":n.style.border="2px solid green",n.style.boxSizing="border-box",t%10==0&&await new Promise(e=>requestAnimationFrame(e)))}})}clearHighlights(){document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass").forEach(e=>{e.style.border=""})}setupNavigationObserver(){const e=()=>{const e=window.location.href;e!==this.lastUrl&&(this.lastUrl=e,this.eventBus.emit("page:changed"))};this.navigationObserver=new MutationObserver(t=>{t.some(e=>e.addedNodes.length>0||e.removedNodes.length>0)&&(clearTimeout(this.navigationCheckTimeout),this.navigationCheckTimeout=setTimeout(e,300))});const t=document.body;t&&this.navigationObserver.observe(t,{childList:!0,subtree:!1}),window.addEventListener("popstate",()=>{clearTimeout(this.navigationCheckTimeout),this.navigationCheckTimeout=setTimeout(e,100)}),setInterval(e,2e3)}cleanup(){i(),this.eventBus.off("config:updated",()=>this.onConfigUpdated()),this.eventBus.off("page:changed",()=>this.onPageChanged()),this.navigationObserver&&this.navigationObserver.disconnect(),clearTimeout(this.navigationCheckTimeout)}}class r{constructor({eventBus:e,config:t}){this.eventBus=e,this.config=t,this.observer=null,this.isProcessing=!1,this.processedModals=new Set,this.pendingRetries=new Map,this.ratingSelector=".bs-rating-star",this.activeClass="active",this.maxRating=5,this.retryAttempts=3,this.retryDelay=1e3,this.homeworkModalSelector="hw-upload-homework",this.modalCheckTimeout=null}init(){this.config.AUTO_RATE_ENABLED&&(this.setupEventListeners(),this.setupMutationObserver())}setupEventListeners(){this.eventBus.on("config:updated",()=>this.onConfigUpdated()),this.eventBus.on("homework:modal-opened",e=>this.onHomeworkModalOpened(e))}onConfigUpdated(){this.config.AUTO_RATE_ENABLED?this.setupMutationObserver():this.cleanup()}onHomeworkModalOpened(e){this.config.AUTO_RATE_ENABLED&&!this.isProcessing&&this.processHomeworkModal(e)}setupMutationObserver(){this.cleanupObserver(),this.observer=new MutationObserver(e=>{e.some(e=>e.addedNodes.length>0)&&(clearTimeout(this.modalCheckTimeout),this.modalCheckTimeout=setTimeout(()=>{this.detectHomeworkModal()},500))}),this.observer.observe(document.body,{childList:!0,subtree:!1})}detectHomeworkModal(){const e=document.querySelector(this.homeworkModalSelector);e&&!this.processedModals.has(e)&&this.eventBus.emit("homework:modal-opened",e)}async processHomeworkModal(e){this.isProcessing=!0,this.processedModals.add(e);try{await this.delay(1e3),await this.fillTimeSpent(),await this.rateMaximum(),await this.selectPositiveTags(),this.config.AUTO_SUBMIT_ENABLED}catch(e){console.error("Ошибка обработки домашнего задания:",e)}finally{this.isProcessing=!1}}async fillTimeSpent(){return new Promise(e=>{setTimeout(()=>{const t=document.querySelectorAll(".text-homework-time-spent-wrap input");t.length>=2&&(t[0].value=Math.floor(2*Math.random())+1,t[1].value=Math.floor(31*Math.random())+15,console.log("⏰ Заполнено время выполнения ДЗ")),e()},500)})}async rateMaximum(){return new Promise(e=>{setTimeout(()=>{document.querySelectorAll(".emoji-evaluation").forEach(e=>{const t=this.generateContainerId(e);if(this.pendingRetries.has(t))return;const n=e.querySelectorAll(this.ratingSelector);if(n.length===this.maxRating){const s=n[this.maxRating-1];if(s.classList.contains(this.activeClass))console.log("✅ Оценка ДЗ уже выставлена на максимум");else{console.log("⭐ Кликаем на 5-ю звезду для оценки ДЗ");this.clickStar(s)&&this.startRetryCycle(e,t,0)}}}),e()},300)})}async selectPositiveTags(){return new Promise(e=>{setTimeout(()=>{console.log("🔍 Ищем доступные теги...");const t=document.querySelectorAll(".evaluation-tags-item");let n=0;t.forEach((e,t)=>{const n=e.querySelector("span")?.textContent,s=o(e),i=e.classList.contains("selected");console.log(`Тег ${t+1}: "${n}", видим: ${s}, выбран: ${i}`)});const s=["Все круто!","Все понятно!","Мне нравится"];t.forEach(e=>{if(!o(e)||n>=2)return;const t=e.querySelector("span")?.textContent;if(console.log(`Проверяем тег: "${t}"`),t&&s.includes(t)&&!e.classList.contains("selected"))try{e.click(),console.log(`✅ Выбран тег: "${t}"`),n++}catch(e){console.error("Ошибка при выборе тега:",e)}}),0===n&&console.log("⚠️ Не найдено подходящих тегов для выбора"),e()},800)})}async submitHomework(){return new Promise(e=>{setTimeout(()=>{const t=document.querySelector(".btn-accept");t&&!t.disabled?(console.log("📤 Отправляем домашнее задание"),t.click()):t&&t.disabled&&console.log("⚠️ Кнопка отправки недоступна, проверьте заполнение полей"),e()},1500)})}startRetryCycle(e,t,n){if(n>=this.retryAttempts)return console.log("❌ Превышено максимальное количество попыток для оценки ДЗ"),void this.pendingRetries.delete(t);console.log(`⏳ Перепроверка оценки ДЗ (попытка ${n+1}/${this.retryAttempts})...`),this.pendingRetries.set(t,setTimeout(()=>{this.checkRatingSuccess(e,t,n)},this.retryDelay))}checkRatingSuccess(e,t,n){const s=e.querySelectorAll(this.ratingSelector);if(0===s.length)return console.log("❌ Элементы оценки исчезли"),void this.pendingRetries.delete(t);const i=s[this.maxRating-1];if(i.classList.contains(this.activeClass))console.log("✅ Оценка ДЗ успешно выставлена!"),this.pendingRetries.delete(t);else{console.log("❌ Оценка ДЗ не прошла, пробуем снова...");this.clickStar(i)?this.startRetryCycle(e,t,n+1):(console.log("❌ Не удалось кликнуть на звезду"),this.pendingRetries.delete(t))}}clickStar(e){if(o(e)&&function(e){if(!e)return!1;const t=window.getComputedStyle(e);return"none"!==t.pointerEvents&&"pointer"===t.cursor&&!e.hasAttribute("disabled")}(e))try{const t=e.querySelector("button.rating-star");return t?(t.click(),!0):(e.click(),!0)}catch(e){return console.error("Ошибка при клике на звезду:",e),!1}return!1}generateContainerId(e){return Array.from(e.parentNode.children).indexOf(e)}delay(e){return new Promise(t=>setTimeout(t,e))}cleanup(){this.cleanupObserver(),this.processedModals.clear(),this.pendingRetries.forEach((e,t)=>{clearTimeout(e),this.pendingRetries.delete(t)}),clearTimeout(this.modalCheckTimeout)}cleanupObserver(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class l{constructor(e,t){this.currentConfig={...e},this.onSave=t,this.modal=null}show(){this.modal?this.modal.style.display="block":this.createModal()}createModal(){this.modal=document.createElement("div"),this.modal.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n            z-index: 10000;\n            min-width: 400px;\n            font-family: Arial, sans-serif;\n        ";const e=document.createElement("h3");e.textContent="Настройки скрипта",e.style.marginTop="0";const t=document.createElement("div"),n=document.createElement("label");n.textContent="Масштаб страницы (%):",n.style.display="block",n.style.marginBottom="5px";const s=document.createElement("input");s.type="number",s.min="10",s.max="200",s.step="5",s.value=this.parseZoomValue(this.currentConfig.ZOOM_LEVEL),s.style.width="100%",s.style.padding="8px",s.style.marginBottom="15px",s.style.boxSizing="border-box";const i=document.createElement("label");i.style.display="flex",i.style.alignItems="center",i.style.marginBottom="15px";const o=document.createElement("input");o.type="checkbox",o.checked=this.currentConfig.AUTO_RATE_ENABLED,o.style.marginRight="10px";const a=document.createElement("span");a.textContent="Включить авто-оценку домашних заданий",i.appendChild(o),i.appendChild(a);const r=document.createElement("div");r.style.display="flex",r.style.justifyContent="space-between",r.style.marginTop="20px";const l=document.createElement("button");l.textContent="Сохранить",l.style.padding="10px 20px",l.style.background="#007bff",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer";const c=document.createElement("button");c.textContent="Отмена",c.style.padding="10px 20px",c.style.background="#6c757d",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",r.appendChild(l),r.appendChild(c),t.appendChild(n),t.appendChild(s),t.appendChild(i),t.appendChild(r),this.modal.appendChild(e),this.modal.appendChild(t);const d=document.createElement("div");d.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0,0,0,0.5);\n            z-index: 9999;\n        ";const h=()=>{document.body.removeChild(d),document.body.removeChild(this.modal),this.modal=null};d.addEventListener("click",h),c.addEventListener("click",h),l.addEventListener("click",()=>{const e=s.value;if(e<10||e>200)return void alert("Масштаб должен быть от 10 до 200%");const t={ZOOM_LEVEL:`${e}%`,AUTO_RATE_ENABLED:o.checked};this.onSave(t),h()}),document.body.appendChild(d),document.body.appendChild(this.modal)}parseZoomValue(e){if("string"==typeof e){const t=parseInt(e.replace("%",""),10);return isNaN(t)?80:t}return 80}hide(){this.modal&&(this.modal.style.display="none")}}class c{constructor({eventBus:e,configManager:t}){this.eventBus=e,this.configManager=t,this.configUI=null}init(){this.setupEventListeners(),this.configManager.registerMenuCommands(this.eventBus)}setupEventListeners(){this.eventBus.on("config:show-ui",()=>this.showConfigUI())}showConfigUI(){try{if(this.configUI)return void this.configUI.show();this.configUI=new l(this.configManager.config,async e=>{await this.configManager.saveConfig(e)&&this.eventBus.emit("config:updated")}),this.configUI.show()}catch(e){console.error("Failed to load ConfigUI module:",e)}}cleanup(){this.eventBus.off("config:show-ui",()=>this.showConfigUI())}}class d{constructor(){this.eventBus=new n,this.configManager=new t,this.modules=new Map,this.isInitialized=!1}async init(){if(!this.isInitialized)try{"undefined"==typeof GM_registerMenuCommand&&console.warn("GM функции недоступны. Меню не будет создано."),await this.configManager.loadConfig(),this.initModules(),this.isInitialized=!0,this.eventBus.emit("app:initialized")}catch(e){console.error("Ошибка инициализации приложения:",e)}}initModules(){this.modules.set("attendance",new a({eventBus:this.eventBus,config:this.configManager.config})),this.modules.set("autoRater",new r({eventBus:this.eventBus,config:this.configManager.config})),this.modules.set("ui",new c({eventBus:this.eventBus,configManager:this.configManager})),this.modules.forEach(e=>e.init())}getModule(e){return this.modules.get(e)}cleanup(){this.modules.forEach(e=>e.cleanup()),this.eventBus.cleanup()}}(async()=>{const e=new d;await e.init(),window.addEventListener("unload",()=>e.cleanup())})()}();
