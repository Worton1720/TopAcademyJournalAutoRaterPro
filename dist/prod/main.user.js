// ==UserScript==
// @name      Top Academy Journal Auto Rater Pro
// @version      0.5
// @description      Автоматизация процессов journal
// @author      Rodion
// @match      https://journal.top-academy.ru/*
// @grant      GM_getValue
// @grant      GM_setValue
// @grant      GM_registerMenuCommand
// @grant      GM_addStyle
// @run-at      document-end
// ==/UserScript==

!function(){"use strict";const t={ZOOM_LEVEL:"80%",PROGRESS_PAGE_REGEX:"https://journal.top-academy.ru/.*/main/progress/.*",AUTO_RATE_ENABLED:!0,AUTO_SUBMIT_ENABLED:!0};class e{constructor(){this.config={...t}}async loadConfig(){try{const e=await GM_getValue("config",{});this.config={...t,...e},this.normalizeConfig()}catch(e){console.warn("Ошибка загрузки конфигурации, используются значения по умолчанию"),this.config={...t}}}async saveConfig(t){try{return this.config={...this.config,...t},this.normalizeConfig(),await GM_setValue("config",this.config),!0}catch(t){return console.error("Ошибка сохранения конфигурации:",t),!1}}normalizeConfig(){if("string"==typeof this.config.PROGRESS_PAGE_REGEX)try{this.config.PROGRESS_PAGE_REGEX=new RegExp(this.config.PROGRESS_PAGE_REGEX)}catch{this.config.PROGRESS_PAGE_REGEX=new RegExp(t.PROGRESS_PAGE_REGEX)}}registerMenuCommands(t){GM_registerMenuCommand("Настройки скрипта",()=>{t.emit("config:show-ui")})}}class s{constructor(){this.events=new Map}on(t,e){return this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(e),()=>this.off(t,e)}off(t,e){this.events.has(t)&&this.events.get(t).delete(e)}emit(t,e){this.events.has(t)&&this.events.get(t).forEach(s=>{try{s(e)}catch(e){console.error(`Ошибка в обработчике события ${t}:`,e)}})}cleanup(){this.events.clear()}}function n(){i();const t=document.createElement("div");return t.id="attendance-stats-widget",t.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: white;\n        border: 2px solid #007bff;\n        border-radius: 8px;\n        padding: 15px;\n        z-index: 9999;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        min-width: 280px;\n        font-family: Arial, sans-serif;\n        transition: all 0.3s ease;\n    ",t.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">\n            <h3 style="margin: 0; font-size: 16px; color: #007bff;">Статистика посещаемости</h3>\n            <button id="toggle-stats" style="background: none; border: none; font-size: 16px; cursor: pointer;">⯆</button>\n        </div>\n        \n        <div id="stats-content" style="margin-bottom: 15px;">\n            Загрузка статистики...\n        </div>\n        \n        <div style="margin-bottom: 10px;">\n            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Период:</label>\n            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">\n                <input type="date" id="date-from" style="flex: 1; padding: 5px; box-sizing: border-box;">\n                <span style="font-weight: bold;">—</span>\n                <input type="date" id="date-to" style="flex: 1; padding: 5px; box-sizing: border-box;">\n            </div>\n        </div>\n        \n        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n            <button id="reset-stats" style="padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Сброс</button>\n            <button id="refresh-stats" style="padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Обновить</button>\n        </div>\n        \n        <style>\n            .progress-bar {\n                width: 100%;\n                height: 8px;\n                background: #e9ecef;\n                border-radius: 4px;\n                margin-top: 5px;\n                overflow: hidden;\n            }\n            \n            .progress-bar-inner {\n                height: 100%;\n                background: #28a745;\n                transition: width 0.3s ease;\n            }\n            \n            .present { color: #28a745; }\n            .lateness { color: #ffc107; }\n            .absent { color: #dc3545; }\n            \n            #attendance-stats-widget.collapsed {\n                height: 40px;\n                overflow: hidden;\n                min-width: auto;\n                width: 200px;\n            }\n            \n            #attendance-stats-widget.collapsed > *:not(:first-child) {\n                display: none;\n            }\n        </style>\n    ',document.body.appendChild(t),t}function i(){const t=document.getElementById("attendance-stats-widget");t&&t.remove()}function o(t){if(!t)return!1;const e=window.getComputedStyle(t);return t.offsetWidth>0&&t.offsetHeight>0&&"hidden"!==e.visibility&&"none"!==e.display&&"0"!==e.opacity}class a{constructor({eventBus:t,config:e}){this.eventBus=t,this.config=e,this.widget=null,this.isCollapsed=!1,this.rangeStart=null,this.rangeEnd=null,this.updateAttendanceStats=function(t,e){let s;return function(...n){clearTimeout(s),s=setTimeout(()=>t.apply(this,n),e)}}(this.updateAttendanceStats.bind(this),300),this.navigationObserver=null,this.lastUrl=window.location.href,this.navigationCheckTimeout=null}init(){this.setupEventListeners(),this.setPageZoom(),this.isProgressPage()&&this.initAttendanceStats(),this.setupNavigationObserver()}setupEventListeners(){this.eventBus.on("config:updated",()=>this.onConfigUpdated()),this.eventBus.on("page:changed",()=>this.onPageChanged())}onConfigUpdated(){this.setPageZoom(),this.isProgressPage()?this.updateAttendanceStats():i()}onPageChanged(){this.isProgressPage()?this.initAttendanceStats():i()}setPageZoom(){document.documentElement.style.zoom=this.config.ZOOM_LEVEL}isProgressPage(){return this.config.PROGRESS_PAGE_REGEX.test(window.location.href)}initAttendanceStats(){this.widget||(this.widget=n(),this.setDefaultDateRange(),this.setupWidgetControls(),this.setupRangeSelection(),this.setupDateInputListeners()),this.updateAttendanceStats()}setDefaultDateRange(){const t=new Date,e=t.getFullYear();String(t.getMonth()+1).padStart(2,"0"),String(t.getDate()).padStart(2,"0"),this.rangeStart=new Date(e,t.getMonth(),1),this.rangeStart.setHours(0,0,0,0),this.rangeEnd=new Date(e,t.getMonth(),t.getDate()),this.rangeEnd.setHours(23,59,59,999),this.syncDateInputs()}setupWidgetControls(){if(!this.widget)return;const t=this.widget.querySelector("#reset-stats"),e=this.widget.querySelector("#refresh-stats"),s=this.widget.querySelector("#toggle-stats");t.addEventListener("click",()=>{this.setDefaultDateRange(),this.clearHighlights(),this.updateAttendanceStats()}),e.addEventListener("click",()=>{this.updateAttendanceStats(),this.highlightRange()}),s.addEventListener("click",()=>{this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.widget.classList.add("collapsed"),s.textContent="⯈"):(this.widget.classList.remove("collapsed"),s.textContent="⯆")})}setupDateInputListeners(){if(!this.widget)return;const t=this.widget.querySelector("#date-from"),e=this.widget.querySelector("#date-to"),s=()=>{const s=t.value,n=e.value;if(s){const t=new Date(s);t.setHours(0,0,0,0),this.rangeStart=t}else this.rangeStart=null;if(n){const t=new Date(n);t.setHours(23,59,59,999),this.rangeEnd=t}else this.rangeEnd=null;this.normalizeDateRange(),this.updateAttendanceStats()};t.addEventListener("change",s),e.addEventListener("change",s)}normalizeDateRange(){this.rangeStart&&this.rangeEnd&&this.rangeStart>this.rangeEnd&&([this.rangeStart,this.rangeEnd]=[this.rangeEnd,this.rangeStart],this.syncDateInputs())}updateAttendanceStats(){this.isProgressPage()?requestAnimationFrame(()=>{this.widget||(this.widget=n());const t=this.calculateStats();this.widget&&(this.widget.querySelector("#stats-content").innerHTML=`\n                Всего занятий: ${t.total}<br>\n                <span class="present">Присутствия: ${t.present}</span><br>\n                <span class="lateness">Опоздания: ${t.lateness}</span><br>\n                <span class="absent">Пропуски: ${t.absent}</span><br>\n                Посещаемость: <b>${t.percentage}%</b>\n                <div class="progress-bar"><div class="progress-bar-inner" style="width:${t.percentage}%;"></div></div>\n            `),requestAnimationFrame(()=>this.highlightRange())}):i()}calculateStats(){const t=this.rangeStart,e=this.rangeEnd,s=document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass");let n=0,i=0,o=0;for(let a=0;a<s.length;a++){const r=s[a],c=r.querySelector(".date")?.textContent.trim();if(!c)continue;const[l,h,d]=c.split(".").map(Number),g=new Date(d,h-1,l);g.setHours(12,0,0,0);(!t||g>=t)&&(!e||g<=e)&&(n++,r.classList.contains("lateness")&&i++,r.classList.contains("pass")&&o++)}const a=n-(o+i);return{total:n,present:a,lateness:i,absent:o,percentage:n>0?((a+i)/n*100).toFixed(1):0}}syncDateInputs(){if(!this.widget)return;const t=this.widget.querySelector("#date-from"),e=this.widget.querySelector("#date-to");if(this.rangeStart){const e=new Date(this.rangeStart);t.value=e.toISOString().split("T")[0]}else t.value="";if(this.rangeEnd){const t=new Date(this.rangeEnd);e.value=t.toISOString().split("T")[0]}else e.value=""}setupRangeSelection(){document.body.addEventListener("click",t=>{const e=t.target.closest(".lessons, .lessons.lateness, .lessons.pass");if(!e)return;const s=e.querySelector(".date");if(!s)return;const[n,i,o]=s.textContent.trim().split(".").map(Number),a=new Date(o,i-1,n);a.setHours(12,0,0,0),t.shiftKey||(this.rangeStart=a),this.rangeEnd=a,this.normalizeDateRange(),this.updateAttendanceStats()})}highlightRange(){this.clearHighlights(),this.rangeStart&&this.rangeEnd&&requestAnimationFrame(async()=>{const t=document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass");for(let e=0;e<t.length;e++){const s=t[e],n=s.querySelector(".date");if(!n)continue;const i=n.textContent.trim();if(!i)continue;const[o,a,r]=i.split(".").map(Number),c=new Date(r,a-1,o);c.setHours(12,0,0,0),c>=this.rangeStart&&c<=this.rangeEnd&&(c.getTime()===this.rangeStart.getTime()||c.getTime()===this.rangeEnd.getTime()?s.style.border="2px solid #ff6b00":s.style.border="2px solid green",s.style.boxSizing="border-box",e%10==0&&await new Promise(t=>requestAnimationFrame(t)))}})}clearHighlights(){document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass").forEach(t=>{t.style.border=""})}setupNavigationObserver(){const t=()=>{const t=window.location.href;t!==this.lastUrl&&(this.lastUrl=t,this.eventBus.emit("page:changed"))};this.navigationObserver=new MutationObserver(e=>{e.some(t=>t.addedNodes.length>0||t.removedNodes.length>0)&&(clearTimeout(this.navigationCheckTimeout),this.navigationCheckTimeout=setTimeout(t,300))});const e=document.body;e&&this.navigationObserver.observe(e,{childList:!0,subtree:!1}),window.addEventListener("popstate",()=>{clearTimeout(this.navigationCheckTimeout),this.navigationCheckTimeout=setTimeout(t,100)}),setInterval(t,2e3)}cleanup(){i(),this.eventBus.off("config:updated",()=>this.onConfigUpdated()),this.eventBus.off("page:changed",()=>this.onPageChanged()),this.navigationObserver&&this.navigationObserver.disconnect(),clearTimeout(this.navigationCheckTimeout)}}class r{constructor({eventBus:t,config:e}){this.eventBus=t,this.config=e,this.observer=null,this.isProcessing=!1,this.processedModals=new Set,this.pendingRetries=new Map,this.ratingSelector=".bs-rating-star",this.activeClass="active",this.maxRating=5,this.retryAttempts=3,this.retryDelay=1e3,this.homeworkModalSelector="hw-upload-homework",this.modalCheckTimeout=null}init(){this.config.AUTO_RATE_ENABLED&&(this.setupEventListeners(),this.setupMutationObserver())}setupEventListeners(){this.eventBus.on("config:updated",()=>this.onConfigUpdated()),this.eventBus.on("homework:modal-opened",t=>this.onHomeworkModalOpened(t))}onConfigUpdated(){this.config.AUTO_RATE_ENABLED?this.setupMutationObserver():this.cleanup()}onHomeworkModalOpened(t){this.config.AUTO_RATE_ENABLED&&!this.isProcessing&&this.processHomeworkModal(t)}setupMutationObserver(){this.cleanupObserver(),this.observer=new MutationObserver(t=>{t.some(t=>t.addedNodes.length>0)&&(clearTimeout(this.modalCheckTimeout),this.modalCheckTimeout=setTimeout(()=>{this.detectHomeworkModal()},500))}),this.observer.observe(document.body,{childList:!0,subtree:!1})}detectHomeworkModal(){const t=document.querySelector(this.homeworkModalSelector);t&&!this.processedModals.has(t)&&this.eventBus.emit("homework:modal-opened",t)}async processHomeworkModal(t){this.isProcessing=!0,this.processedModals.add(t);try{await this.delay(1e3),await this.fillTimeSpent(),await this.rateMaximum(),await this.selectPositiveTags(),this.config.AUTO_SUBMIT_ENABLED}catch(t){console.error("Ошибка обработки домашнего задания:",t)}finally{this.isProcessing=!1}}async fillTimeSpent(){return new Promise(t=>{setTimeout(()=>{const e=document.querySelectorAll(".text-homework-time-spent-wrap input");e.length>=2&&(e[0].value=Math.floor(2*Math.random())+1,e[1].value=Math.floor(31*Math.random())+15,console.log("⏰ Заполнено время выполнения ДЗ")),t()},500)})}async rateMaximum(){return new Promise(t=>{setTimeout(()=>{document.querySelectorAll(".emoji-evaluation").forEach(t=>{const e=this.generateContainerId(t);if(this.pendingRetries.has(e))return;const s=t.querySelectorAll(this.ratingSelector);if(s.length===this.maxRating){const n=s[this.maxRating-1];if(n.classList.contains(this.activeClass))console.log("✅ Оценка ДЗ уже выставлена на максимум");else{console.log("⭐ Кликаем на 5-ю звезду для оценки ДЗ");this.clickStar(n)&&this.startRetryCycle(t,e,0)}}}),t()},300)})}async selectPositiveTags(){return new Promise(t=>{setTimeout(()=>{console.log("🔍 Ищем доступные теги...");const e=document.querySelectorAll(".evaluation-tags-item");let s=0;e.forEach((t,e)=>{const s=t.querySelector("span")?.textContent,n=o(t),i=t.classList.contains("selected");console.log(`Тег ${e+1}: "${s}", видим: ${n}, выбран: ${i}`)});const n=["Все круто!","Все понятно!","Мне нравится"];e.forEach(t=>{if(!o(t)||s>=2)return;const e=t.querySelector("span")?.textContent;if(console.log(`Проверяем тег: "${e}"`),e&&n.includes(e)&&!t.classList.contains("selected"))try{t.click(),console.log(`✅ Выбран тег: "${e}"`),s++}catch(t){console.error("Ошибка при выборе тега:",t)}}),0===s&&console.log("⚠️ Не найдено подходящих тегов для выбора"),t()},800)})}async submitHomework(){return new Promise(t=>{setTimeout(()=>{const e=document.querySelector(".btn-accept");e&&!e.disabled?(console.log("📤 Отправляем домашнее задание"),e.click()):e&&e.disabled&&console.log("⚠️ Кнопка отправки недоступна, проверьте заполнение полей"),t()},1500)})}startRetryCycle(t,e,s){if(s>=this.retryAttempts)return console.log("❌ Превышено максимальное количество попыток для оценки ДЗ"),void this.pendingRetries.delete(e);console.log(`⏳ Перепроверка оценки ДЗ (попытка ${s+1}/${this.retryAttempts})...`),this.pendingRetries.set(e,setTimeout(()=>{this.checkRatingSuccess(t,e,s)},this.retryDelay))}checkRatingSuccess(t,e,s){const n=t.querySelectorAll(this.ratingSelector);if(0===n.length)return console.log("❌ Элементы оценки исчезли"),void this.pendingRetries.delete(e);const i=n[this.maxRating-1];if(i.classList.contains(this.activeClass))console.log("✅ Оценка ДЗ успешно выставлена!"),this.pendingRetries.delete(e);else{console.log("❌ Оценка ДЗ не прошла, пробуем снова...");this.clickStar(i)?this.startRetryCycle(t,e,s+1):(console.log("❌ Не удалось кликнуть на звезду"),this.pendingRetries.delete(e))}}clickStar(t){if(o(t)&&function(t){if(!t)return!1;const e=window.getComputedStyle(t);return"none"!==e.pointerEvents&&"pointer"===e.cursor&&!t.hasAttribute("disabled")}(t))try{const e=t.querySelector("button.rating-star");return e?(e.click(),!0):(t.click(),!0)}catch(t){return console.error("Ошибка при клике на звезду:",t),!1}return!1}generateContainerId(t){return Array.from(t.parentNode.children).indexOf(t)}delay(t){return new Promise(e=>setTimeout(e,t))}cleanup(){this.cleanupObserver(),this.processedModals.clear(),this.pendingRetries.forEach((t,e)=>{clearTimeout(t),this.pendingRetries.delete(e)}),clearTimeout(this.modalCheckTimeout)}cleanupObserver(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class c{constructor({eventBus:t,configManager:e}){this.eventBus=t,this.configManager=e,this.configUI=null}init(){this.setupEventListeners(),this.configManager.registerMenuCommands(this.eventBus)}setupEventListeners(){this.eventBus.on("config:show-ui",()=>this.showConfigUI())}showConfigUI(){this.configUI||(this.configUI=new ConfigUI(this.configManager.config,async t=>{await this.configManager.saveConfig(t)&&this.eventBus.emit("config:updated")})),this.configUI.show()}cleanup(){this.eventBus.off("config:show-ui",()=>this.showConfigUI())}}class l{constructor(){this.eventBus=new s,this.configManager=new e,this.modules=new Map,this.isInitialized=!1}async init(){if(!this.isInitialized)try{"loading"===document.readyState&&await new Promise(t=>document.addEventListener("DOMContentLoaded",t)),await this.configManager.loadConfig(),requestAnimationFrame(()=>{this.initModules(),this.isInitialized=!0,this.eventBus.emit("app:initialized")})}catch(t){console.error("Ошибка инициализации приложения:",t)}}initModules(){this.modules.set("attendance",new a({eventBus:this.eventBus,config:this.configManager.config})),this.modules.set("autoRater",new r({eventBus:this.eventBus,config:this.configManager.config})),this.modules.set("ui",new c({eventBus:this.eventBus,configManager:this.configManager})),this.modules.forEach(t=>t.init())}getModule(t){return this.modules.get(t)}cleanup(){this.modules.forEach(t=>t.cleanup()),this.eventBus.cleanup()}}(async()=>{const t=new l;await t.init(),window.addEventListener("unload",()=>t.cleanup())})()}();
